<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµë¦¬êµìœ¡ ì¶œì„ë¶€ ìƒì„±ê¸°</title>
    <!-- PDF/ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px dashed #ddd;
        }

        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        input[type="file"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            flex: 1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .btn-download {
            background: #FF9800;
            color: white;
        }

        .btn-download:hover {
            background: #F57C00;
        }

        .btn-print {
            background: #ff9800;
            color: white;
        }

        .btn-print:hover {
            background: #e68900;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .team-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .team-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: #e3f2fd;
            border-radius: 5px;
            font-size: 13px;
        }

        .team-checkbox input {
            cursor: pointer;
        }

        .attendance-sheets {
            display: none;
        }

        .sheet {
            page-break-after: always;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .sheet-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #000;
            position: relative;
        }

        .sheet-title {
            font-size: 28px;
            font-weight: bold;
            color: #000;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .sheet-subtitle {
            font-size: 15px;
            color: #000;
            font-weight: normal;
        }

        .lunch-summary {
            position: absolute;
            top: 0;
            left: 0;
            font-size: 19px;
            color: #000;
            font-weight: bold;
            padding: 5px 10px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border: 2px solid #000;
        }

        .attendance-table th {
            background: white;
            color: #000;
            padding: 10px 6px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #000;
            border-bottom: 2px solid #000;
        }

        .attendance-table td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #000;
            font-size: 13px;
            background: white;
        }

        .attendance-table tr:nth-child(even) {
            background: white;
        }

        .attendance-table tr:hover {
            background: white;
        }

        .attendance-table td.id-col {
            text-align: left;
            font-weight: 500;
            padding-left: 12px;
            font-size: 17px !important;
            color: #000;
            white-space: nowrap; /* ì¸ì‡„ ì‹œì—ë„ ì´ë¦„+ë²ˆí˜¸ê°€ í•œ ì¤„ë¡œ ë‚˜ì˜¤ë„ë¡ */
        }

        .lunch-col {
            background: white !important;
        }

        .attendance-table th.lunch-col {
            background: white !important;
        }

        .attendance-table td.lunch-col {
            background: white !important;
        }

        .attendance-table td.lunch-col.present {
            background: #f5f5f5 !important;
        }

        .attendance-table td.lunch-col.absent {
            background: white !important;
        }

        .attendance-table td.lunch-col .attendance-box {
            background: transparent !important;
        }

        .check-col {
            width: 46px;
            height: 32px;
            text-align: center;
            padding: 0;
            vertical-align: middle;
        }

        .attendance-box {
            width: 100%;
            height: 100%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: normal;
            background: white;
            color: #000;
            line-height: 1;
            min-height: 32px;
        }

        .attendance-box.empty {
            border: none;
            background: white;
        }

        .attendance-box.present {
            background: white;
            color: #000;
            border: none;
        }

        .attendance-box.absent {
            background: white;
            color: #000;
            border: none;
        }

        .attendance-box.special {
            background: white;
            color: #000;
            border: none;
            font-size: 10px;
        }

        .info-box {
            background: white;
            padding: 15px;
            border: 1px solid #000;
            margin-bottom: 20px;
            font-size: 14px;
            color: #000;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #999;
            font-size: 16px;
        }

        /* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
        @media print {
            /* ì¼ë°˜ ì¶œì„ë¶€ëŠ” landscape */
            @page {
                margin: 0;
                size: A4 landscape;
                marks: none;
            }
            
            /* ê¹€ë°¥ ê³„ìˆ˜í‘œëŠ” portrait */
            body:has(.lunch-sheet) @page,
            .lunch-sheet @page {
                size: A4 portrait !important;
                margin: 1cm !important;
            }

            @page :first {
                margin: 0;
            }

            @page :left {
                margin: 0;
            }

            @page :right {
                margin: 0;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
            }

            /* ë¸Œë¼ìš°ì € ê¸°ë³¸ ë¨¸ë¦¬ê¸€/ë°”ë‹¥ê¸€ ì™„ì „ ì œê±° */
            @page {
                @top-left { content: ""; }
                @top-center { content: ""; }
                @top-right { content: ""; }
                @bottom-left { content: ""; }
                @bottom-center { content: ""; }
                @bottom-right { content: ""; }
            }

            .container {
                box-shadow: none;
                padding: 0;
            }

            h1,
            .subtitle,
            .upload-section,
            .controls,
            .team-selector,
            .info-box {
                display: none !important;
            }

            .sheet {
                page-break-after: always;
                page-break-inside: avoid;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 30px;
                margin-bottom: 30px;
                background: white;
                box-shadow: none;
            }

            .sheet:last-child {
                page-break-after: auto;
            }

            .sheet-header {
                border-bottom: 2px solid #000;
                margin-bottom: 20px;
                padding-bottom: 12px;
                position: relative;
            }

            .sheet-title {
                font-size: 28px;
                font-weight: bold;
                color: #000;
                margin-bottom: 4px;
                letter-spacing: 0.5px;
            }

            .sheet-subtitle {
                font-size: 15px;
                color: #000;
                font-weight: normal;
            }

            .lunch-summary {
                position: absolute;
                top: 0;
                left: 0;
                font-size: 19px;
                color: #000;
                font-weight: bold;
                padding: 5px 10px;
            }

            .attendance-table {
                font-size: 13px;
                border-collapse: collapse;
                width: 100%;
                border: 2px solid #000;
                margin-top: 15px;
            }

            .attendance-table th,
            .attendance-table td {
                padding: 8px 6px;
                border: 1px solid #000;
            }

            .attendance-table th {
                background: white !important;
                color: #000;
                padding: 10px 6px;
                text-align: center;
                font-size: 12px;
                font-weight: bold;
                border: 1px solid #000;
                border-bottom: 2px solid #000;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .attendance-table th.lunch-col,
            .attendance-table td.lunch-col {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .attendance-table td.lunch-col.present {
                background: #f5f5f5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .attendance-table td.lunch-col.absent {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .attendance-table td.lunch-col .attendance-box {
                background: transparent !important;
            }

            .lunch-summary {
                font-size: 19px; /* í™”ë©´ê³¼ ë™ì¼í•˜ê²Œ í¬ê²Œ í‘œì‹œ */
                border: none;
                display: flex !important;
                flex-direction: column !important;
                gap: 2px !important;
            }

            .attendance-table td {
                padding: 8px 6px;
                text-align: center;
                border: 1px solid #000;
                font-size: 13px;
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .check-col {
                width: 46px;
                height: 32px;
                text-align: center;
                padding: 0;
                vertical-align: middle;
            }

            .attendance-box {
                width: 100%;
                height: 100%;
                border: none;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                font-weight: normal;
                background: white;
                color: #000;
                line-height: 1;
                min-height: 32px;
            }

            .attendance-box.present {
                background: white !important;
                border: none;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .attendance-box.absent {
                background: white !important;
                border: none;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .attendance-box.special {
                background: white !important;
                font-size: 9px;
                border: none;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .attendance-box.empty {
                background: white !important;
                border: none;
            }

            .check-col {
                width: 40px;
                padding: 0;
            }

            .attendance-table td.id-col {
                text-align: left;
                font-weight: 500;
                padding-left: 12px;
                font-size: 17px !important;
                color: #000;
            }

            @page {
                margin: 1cm;
                size: A4 landscape;
                marks: none;
            }

            @page :first {
                margin: 1cm;
            }

            @page :left {
                margin: 1cm;
            }

            @page :right {
                margin: 1cm;
            }

            /* ë¸Œë¼ìš°ì € ê¸°ë³¸ í˜ì´ì§€ ë²ˆí˜¸ ë° ê²½ë¡œ ìˆ¨ê¸°ê¸° */
            @media print {
                @page {
                    margin-bottom: 0;
                }
            }

            /* í”„ë¦°íŠ¸ ì‹œì—ë„ hidden í´ë˜ìŠ¤ê°€ ì ìš©ëœ ìš”ì†Œ ìˆ¨ê¹€ */
            .hidden {
                display: none !important;
            }
        }

        .hidden {
            display: none !important;
        }

        /* ê¹€ë°¥ ê³„ìˆ˜í‘œ ì „ìš© ìŠ¤íƒ€ì¼ */
        .lunch-sheet {
            padding: 8px;
        }

        .lunch-header {
            margin-bottom: 5px;
            padding-bottom: 4px;
        }

        .lunch-header .sheet-title {
            font-size: 18px;
        }

        .lunch-header .sheet-subtitle {
            font-size: 11px;
        }

        .lunch-header .lunch-summary {
            font-size: 13px;
        }

        .staff-info {
            font-size: 15px;
            color: #000;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .lunch-teams-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-top: 8px;
        }

        .lunch-team-block {
            border: 2px solid #000;
            padding: 3px;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .lunch-team-header {
            font-weight: bold;
            font-size: 12px;
            padding: 3px;
            background: #f0f0f0;
            border-bottom: 2px solid #000;
            margin-bottom: 3px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .lunch-team-name {
            font-size: 16px;
            font-weight: bold;
        }

        .lunch-count {
            font-size: 18px;
            color: #000;
            font-weight: bold;
        }

        .lunch-members-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .lunch-member-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2px;
            padding: 1px 2px;
            font-size: 9px;
        }

        .lunch-member-id {
            flex: 1;
            font-size: 9px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .lunch-member-status {
            font-size: 9px;
            font-weight: bold;
            color: #000;
            min-width: 12px;
            text-align: center;
        }

        /* ì¸ì‡„ ì‹œ ê¹€ë°¥ ê³„ìˆ˜í‘œ ìµœì í™” */
        @media print {
            /* ê¹€ë°¥ ê³„ìˆ˜í‘œ ëª¨ë“œì¼ ë•Œ í˜ì´ì§€ ë°©í–¥ ë³€ê²½ */
            body.lunch-mode @page {
                size: A4 portrait !important;
                margin: 1cm !important;
            }
            
            .lunch-sheet {
                padding: 5px !important;
                margin: 0 !important;
                page-break-after: always;
                page-break-inside: avoid;
            }

            .lunch-sheet:last-child {
                page-break-after: auto;
            }

            .lunch-header {
                margin-bottom: 3px !important;
                padding-bottom: 3px !important;
            }

            .lunch-header .sheet-title {
                font-size: 14px !important;
                margin-bottom: 1px !important;
            }

            .lunch-header .sheet-subtitle {
                font-size: 9px !important;
            }

            .lunch-header .lunch-summary {
                font-size: 10px !important;
                padding: 1px 4px !important;
            }

            .staff-info {
                font-size: 14px !important;
                color: #000 !important;
                font-weight: 600 !important;
            }

            .lunch-teams-grid {
                grid-template-columns: repeat(8, 1fr) !important;
                gap: 3px !important;
                margin-top: 5px !important;
            }

            .lunch-team-block {
                padding: 2px !important;
                page-break-inside: avoid;
                border: 1.5px solid #000 !important;
                display: flex !important;
                flex-direction: column !important;
            }

            .lunch-team-header {
                font-size: 10px !important;
                padding: 2px !important;
                margin-bottom: 2px !important;
                flex-shrink: 0 !important;
            }

            .lunch-team-name {
                font-size: 16px !important;
            }

            .lunch-count {
                font-size: 16px !important;
            }

            .lunch-members-list {
                gap: 0.5px !important;
            }

            .lunch-member-row {
                gap: 1px !important;
                padding: 0.5px 1px !important;
                font-size: 8px !important;
            }

            .lunch-member-id {
                font-size: 8px !important;
            }

            .lunch-member-status {
                font-size: 8px !important;
                min-width: 10px !important;
            }

            .sheet {
                padding: 5px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ êµë¦¬êµìœ¡ ì¶œì„ë¶€ ìƒì„±ê¸°</h1>
        <p class="subtitle">CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì¡°ë³„ ì¶œì„ë¶€ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</p>

        <div class="upload-section">
            <div class="mode-selector" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">ì‘ì—… ëª¨ë“œ ì„ íƒ:</label>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="modeAttendance" onclick="setMode('attendance')" style="background: #2196F3;">ğŸ“‹ ì¼ë°˜ ì¶œì„ë¶€</button>
                    <button class="btn btn-secondary" id="modeLunch" onclick="setMode('lunch')" style="background: #9C27B0;">ğŸ™ ê¹€ë°¥ ê³„ìˆ˜</button>
                </div>
            </div>
            
            <!-- ê¹€ë°¥ ê³„ìˆ˜ ëª¨ë“œì¼ ë•Œë§Œ ë³´ì´ëŠ” êµì—­ì ì„¤ì • -->
            <div id="staffSettings" style="display: none; margin-bottom: 12px; padding: 10px 14px; background: #fafafa; border-radius: 6px; border: 1px solid #e0e0e0;">
                <div style="display: flex; gap: 16px; align-items: center; font-size: 13px;">
                    <span style="color: #555; font-weight: 500;">ğŸ‘” êµì—­ì:</span>
                    <label style="display: flex; align-items: center; gap: 6px; color: #666;">
                        ì¹¼ë¹ˆ
                        <input type="number" id="calvinStaffCount" value="" min="0" placeholder="0" style="width: 45px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center; transition: all 0.2s;">
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; color: #666;">
                        ì›¨ìŠ¬ë¦¬
                        <input type="number" id="wesleyStaffCount" value="" min="0" placeholder="0" style="width: 45px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center; transition: all 0.2s;">
                    </label>
                </div>
            </div>
            
            <style>
                #staffSettings input[type="number"]:focus {
                    outline: none;
                    border-color: #4CAF50;
                    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
                }
                
                #staffSettings input[type="number"]:hover {
                    border-color: #bbb;
                }
            </style>
            
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv" multiple />
                <button class="btn btn-primary" onclick="loadCSV()">ğŸ“ CSV íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</button>
            </div>
            <div class="info-box" id="fileInfo" style="display: none;">
                <strong>íŒŒì¼ ì •ë³´:</strong> <span id="fileName"></span> | 
                <strong>ì´ ì¡° ìˆ˜:</strong> <span id="teamCount"></span>ê°œ
            </div>
        </div>

        <div class="controls" id="controls" style="display: none;">
            <button class="btn btn-print" onclick="printAll()">ğŸ–¨ï¸ ì „ì²´ ì¸ì‡„</button>
            <button class="btn btn-download" onclick="downloadAsPDF(this)">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-download" onclick="downloadAsImage(this)">ğŸ–¼ï¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-secondary" onclick="selectAllTeams()">ì „ì²´ ì„ íƒ</button>
            <button class="btn btn-secondary" onclick="deselectAllTeams()">ì „ì²´ í•´ì œ</button>
            <button class="btn btn-print" onclick="printSelected()">ì„ íƒí•œ ì¡°ë§Œ ì¸ì‡„</button>
        </div>

        <div class="team-selector" id="teamSelector" style="display: none;"></div>

        <div class="attendance-sheets" id="attendanceSheets"></div>
    </div>

    <script>
        let teamsData = [];
        let dateHeaders = []; // CSVì—ì„œ íŒŒì‹±í•œ ë‚ ì§œ í—¤ë”
        let currentMode = 'attendance'; // 'attendance' ë˜ëŠ” 'lunch'

        async function loadCSV() {
            const fileInput = document.getElementById('csvFile');
            const files = fileInput.files;

            if (files.length === 0) {
                alert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì—¬ëŸ¬ íŒŒì¼ì„ ì½ì–´ì„œ í…ìŠ¤íŠ¸ ë°°ì—´ë¡œ ì €ì¥
            const fileTexts = [];
            const fileNames = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                fileNames.push(file.name);
                
                const text = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file, 'UTF-8');
                });
                
                fileTexts.push(text);
            }

            // ì—¬ëŸ¬ CSV íŒŒì¼ì„ í•©ì³ì„œ íŒŒì‹±
            parseMultipleCSV(fileTexts, fileNames);
        }

        // CSV ë¼ì¸ì„ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜ (ì‰¼í‘œë¡œ ë¶„ë¦¬í•˜ë˜ ë”°ì˜´í‘œ ì²˜ë¦¬)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // ì—¬ëŸ¬ CSV íŒŒì¼ì„ í•©ì³ì„œ íŒŒì‹±í•˜ëŠ” í•¨ìˆ˜
        function parseMultipleCSV(fileTexts, fileNames) {
            if (fileTexts.length === 0) return;

            // ì²« ë²ˆì§¸ íŒŒì¼ì—ì„œ í—¤ë” ì¶”ì¶œ
            const firstLines = fileTexts[0].split('\n');
            let headerLine = '';
            
            for (let line of firstLines) {
                if (line.trim()) {
                    headerLine = line;
                    break;
                }
            }

            // ëª¨ë“  íŒŒì¼ì˜ ë°ì´í„° ë¼ì¸ì„ í•©ì¹¨ (í—¤ë” ì œì™¸)
            let allDataLines = [];
            
            fileTexts.forEach((text, index) => {
                const lines = text.split('\n');
                let isFirstLine = true;
                
                lines.forEach(line => {
                    if (!line.trim()) return;
                    
                    // ì²« ë²ˆì§¸ ì¤„(í—¤ë”)ì€ ê±´ë„ˆë›°ê¸°
                    if (isFirstLine) {
                        isFirstLine = false;
                        return;
                    }
                    
                    allDataLines.push(line);
                });
            });

            // í—¤ë” + í•©ì³ì§„ ë°ì´í„°ë¡œ í•˜ë‚˜ì˜ CSV í…ìŠ¤íŠ¸ ìƒì„±
            const combinedCSV = headerLine + '\n' + allDataLines.join('\n');
            
            // ê¸°ì¡´ parseCSV í•¨ìˆ˜ í˜¸ì¶œ
            parseCSV(combinedCSV, fileNames);
        }

        function parseCSV(text, fileNames = null) {
            const lines = text.split('\n');
            const teams = {};
            let isFirstLine = true;

            lines.forEach((line, index) => {
                // ë¹ˆ ì¤„ ìŠ¤í‚µ
                if (!line.trim()) return;
                
                const parts = parseCSVLine(line);

                // ì²« ë²ˆì§¸ ì¤„(í—¤ë”)ì—ì„œ ë‚ ì§œ ì •ë³´ íŒŒì‹±
                if (isFirstLine) {
                    // í—¤ë”: NOTE,Lunch,Location,Team,ID,11/02,11/09,...
                    // 5ë²ˆì§¸ ì»¬ëŸ¼(ID) ì´í›„ê°€ ë‚ ì§œë“¤
                    // ë¹ˆ ë¬¸ìì—´ì„ ì œê±°í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ìœ ì§€ (ì¶œì„ ë°ì´í„°ì™€ ì¸ë±ìŠ¤ ë§ì¶”ê¸° ìœ„í•´)
                    dateHeaders = parts.slice(5).map(d => d.trim());
                    // ë‚ ì§œê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì œí•œí•˜ì§€ ì•ŠìŒ)
                    // ë‹¨, ìµœëŒ€ 12ì£¼ì°¨ê¹Œì§€ë§Œ ì‚¬ìš©í•˜ë„ë¡ ì œí•œ (ë¹ˆ ì¹¸ìœ¼ë¡œ ì±„ì›€)
                    const maxWeeks = 12;
                    while (dateHeaders.length < maxWeeks) {
                        dateHeaders.push('');
                    }
                    dateHeaders = dateHeaders.slice(0, maxWeeks);
                    
                    // ë””ë²„ê¹…: í—¤ë” ì •ë³´ ì¶œë ¥
                    console.log('CSV í—¤ë” íŒŒì‹±:', {
                        dateHeaders: dateHeaders,
                        dateHeadersLength: dateHeaders.length,
                        lastDateIndex: dateHeaders.length - 1,
                        lastDate: dateHeaders[dateHeaders.length - 1]
                    });
                    
                    isFirstLine = false;
                    return;
                }

                if (parts.length < 5) return;

                // CSV ì»¬ëŸ¼ êµ¬ì¡°: NOTE(0), Lunch(1), Location(2), Team(3), ID(4), ì¶œì„ë°ì´í„°ë“¤(5~)
                const note = parts[0].trim();
                const lunch = parts[1].trim(); // ê¹€ë°¥ ì—¬ë¶€
                const location = parts[2].trim();
                const team = parts[3].trim();
                const idField = parts[4].trim();

                // ë¹ˆ ì¤„ ìŠ¤í‚µ
                if (!location || !team || !idField) return;

                // NOTEê°€ ìˆ«ìë§Œ ìˆëŠ” ì¤„ì€ í•©ê³„/êµ¬ë¶„ì„ ì´ë¯€ë¡œ ìŠ¤í‚µ
                if (note && /^\d+$/.test(note)) return;

                // ì¶œì„ ë°ì´í„° ì¶”ì¶œ (5ë²ˆì§¸ ì»¬ëŸ¼ë¶€í„°)
                const attendanceData = parts.slice(5).map(d => d.trim());
                // dateHeadersì™€ ë™ì¼í•œ ê¸¸ì´ë¡œ ë§ì¶”ê¸° (ë¶€ì¡±í•˜ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì±„ì›€)
                const maxWeeks = dateHeaders.length || 12;
                while (attendanceData.length < maxWeeks) {
                    attendanceData.push('');
                }
                const attendance = attendanceData.slice(0, maxWeeks);
                
                // ë””ë²„ê¹…: ì´ì§€í˜•4089ì¸ ê²½ìš° ìƒì„¸ ì •ë³´ ì¶œë ¥
                if (idField === 'ì´ì§€í˜•4089') {
                    console.log('ì´ì§€í˜•4089 CSV íŒŒì‹±:', {
                        lineIndex: index,
                        parts: parts,
                        partsLength: parts.length,
                        attendanceData: attendanceData,
                        attendance: attendance,
                        dateHeaders: dateHeaders,
                        dateHeadersLength: dateHeaders.length
                    });
                }

                const teamKey = `${location}_${team}`;

                if (!teams[teamKey]) {
                    teams[teamKey] = {
                        location: location,
                        team: team,
                        members: []
                    };
                }

                // IDë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥ (ì´ë¦„+ì „í™”ë²ˆí˜¸ ë¶„ë¦¬í•˜ì§€ ì•ŠìŒ)
                teams[teamKey].members.push({
                    id: idField, // ID ê·¸ëŒ€ë¡œ ì €ì¥
                    note: note || '', // NOTE ì €ì¥
                    lunch: lunch || '', // ê¹€ë°¥ ì—¬ë¶€ ì €ì¥
                    attendance: attendance // ì¶œì„ ë°ì´í„° ì €ì¥
                });
            });

            teamsData = Object.values(teams);
            displaySheets();
            displayControls();
        }

        function setMode(mode) {
            currentMode = mode;
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.getElementById('modeAttendance').style.background = mode === 'attendance' ? '#2196F3' : '#ccc';
            document.getElementById('modeLunch').style.background = mode === 'lunch' ? '#9C27B0' : '#ccc';
            
            // êµì—­ì ì„¤ì • í‘œì‹œ/ìˆ¨ê¹€
            document.getElementById('staffSettings').style.display = mode === 'lunch' ? 'block' : 'none';
            
            // body í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸ (í™”ë©´ì—ì„œëŠ” í•„ìš” ì—†ì§€ë§Œ ì¼ê´€ì„±ì„ ìœ„í•´)
            if (mode === 'lunch') {
                document.body.classList.add('lunch-mode');
            } else {
                document.body.classList.remove('lunch-mode');
            }
            
            // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ í‘œì‹œ
            if (teamsData.length > 0) {
                displaySheets();
                displayControls();
            }
        }

        function displaySheets() {
            const container = document.getElementById('attendanceSheets');
            container.innerHTML = '';
            container.style.display = 'block';

            // DocumentFragment ì‚¬ìš©í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ
            const fragment = document.createDocumentFragment();

            if (currentMode === 'attendance') {
                // ì¼ë°˜ ì¶œì„ë¶€ ëª¨ë“œ
                teamsData.forEach((team, index) => {
                    const sheet = createSheet(team, index);
                    fragment.appendChild(sheet);
                });
            } else {
                // ê¹€ë°¥ ê³„ìˆ˜ ëª¨ë“œ
                const lunchSheets = createLunchSheets();
                lunchSheets.forEach(sheet => {
                    fragment.appendChild(sheet);
                });
            }

            container.appendChild(fragment);
        }

        // ì‹¤ì œ ì¶œì„ ë°ì´í„°ê°€ ìˆëŠ” ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œ ì—´ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
        function getLatestDateIndex() {
            if (teamsData.length === 0) return -1;
            
            // ëª¨ë“  ë©¤ë²„ì˜ attendanceë¥¼ í™•ì¸í•´ì„œ ê°’ì´ ìˆëŠ” ê°€ì¥ í° ì¸ë±ìŠ¤ ì°¾ê¸°
            let maxIndex = -1;
            
            teamsData.forEach(team => {
                team.members.forEach(member => {
                    if (!member.attendance) return;
                    
                    // ê° ë©¤ë²„ì˜ ë§ˆì§€ë§‰ ê°’ì´ ìˆëŠ” ì¸ë±ìŠ¤ ì°¾ê¸°
                    for (let i = member.attendance.length - 1; i >= 0; i--) {
                        const value = member.attendance[i];
                        if (value && value.trim() !== '') {
                            if (i > maxIndex) {
                                maxIndex = i;
                            }
                            break;
                        }
                    }
                });
            });
            
            console.log('ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œ ì¸ë±ìŠ¤ ì°¾ê¸°:', {
                maxIndex: maxIndex,
                maxDate: dateHeaders[maxIndex]
            });
            
            return maxIndex;
        }

        // ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œ ì—´ì— 'ëŒë´„'ì´ ìˆëŠ”ì§€ í™•ì¸
        function isDolbomOnLatestDate(member) {
            // CSV í—¤ë”ì˜ ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œ ì¸ë±ìŠ¤ ì°¾ê¸°
            const latestIndex = getLatestDateIndex();
            if (latestIndex === -1) {
                return false;
            }
            
            // í•´ë‹¹ ë‚ ì§œ(ì¸ë±ìŠ¤)ì˜ attendance ê°’ í™•ì¸
            const attendanceValue = member.attendance && member.attendance[latestIndex];
            const isDolbom = attendanceValue && attendanceValue.trim() === 'ëŒë´„';
            
            // ë””ë²„ê¹…: íŠ¹ì • ì¸ì› ë¡œê·¸ ì¶œë ¥
            if (member.id === 'ì´ì§€í˜•4089' || member.id === 'ê¹€ì¸ë˜7346' || member.id === 'ì „ìë£¡7684') {
                console.log(`${member.id} ë””ë²„ê¹…:`, {
                    latestIndex: latestIndex,
                    latestDate: dateHeaders[latestIndex],
                    attendance: member.attendance,
                    attendanceAtLatestIndex: attendanceValue,
                    attendanceValueRaw: `"${attendanceValue}"`,
                    isDolbom: isDolbom,
                    lunchValue: member.lunch
                });
            }
            
            return isDolbom;
        }

        // ê¹€ë°¥ ê°œìˆ˜ ê³„ì‚° í•¨ìˆ˜ (ì´í˜„ìˆ™9735ëŠ” 2ê°œ, ë‚˜ë¨¸ì§€ëŠ” 1ê°œ)
        // ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œ ì—´ì— 'ëŒë´„'ì´ ìˆìœ¼ë©´ ê¹€ë°¥ ë¯¸ê³„ìˆ˜
        function getLunchCount(member) {
            if (member.lunch !== 'O') return 0;
            
            // ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œ ì—´ì— 'ëŒë´„'ì´ë©´ 0ê°œ
            if (isDolbomOnLatestDate(member)) {
                return 0;
            }
            
            // ì´í˜„ìˆ™9735ëŠ” 2ê°œë¡œ ì¹´ìš´íŠ¸
            if (member.id === 'ì´í˜„ìˆ™9735') return 2;
            return 1;
        }

        // íŒ€ì˜ ì´ ê¹€ë°¥ ê°œìˆ˜ ê³„ì‚°
        function calculateTeamLunchCount(members) {
            return members.reduce((total, member) => total + getLunchCount(member), 0);
        }

        function createSheet(team, index) {
            const sheet = document.createElement('div');
            sheet.className = 'sheet';
            sheet.id = `sheet-${index}`;
            sheet.dataset.teamKey = `${team.location}_${team.team}`;

            // ê¹€ë°¥ ê°œìˆ˜ ê³„ì‚°
            const lunchCount = calculateTeamLunchCount(team.members);

            const header = document.createElement('div');
            header.className = 'sheet-header';
            header.innerHTML = `
                <div class="sheet-subtitle">ì „êµì¸ êµë¦¬êµìœ¡ ì¶œì„ë¶€</div>
                <div class="sheet-title">${team.location} - ${team.team}</div>
                <div class="lunch-summary">ê¹€ë°¥: ${lunchCount}ê°œ</div>
            `;

            const table = document.createElement('table');
            table.className = 'attendance-table';

            // í…Œì´ë¸” í—¤ë”
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `
                <th style="width: 45px;">ë²ˆí˜¸</th>
                <th class="lunch-col" style="width: 45px;">ê¹€ë°¥</th>
                <th style="width: 200px;">NOTE</th>
                <th style="width: 85px;">ID</th>
                ${dateHeaders.map((date, idx) => `<th class="check-col">${date || `${idx + 1}ì£¼ì°¨`}</th>`).join('')}
            `;
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // í…Œì´ë¸” ë°”ë””
            const tbody = document.createElement('tbody');
            team.members.forEach((member, idx) => {
                const row = document.createElement('tr');
                
                // ì¶œì„ ìƒíƒœì— ë”°ë¼ í‘œì‹œ
                const attendanceCells = member.attendance.map(status => {
                    if (!status || status === '') {
                        return '<td class="check-col"><div class="attendance-box empty"></div></td>';
                    }
                    const statusClass = status === 'O' ? 'present' : 
                                       status === 'X' ? 'absent' : 
                                       'special';
                    return `<td class="check-col"><div class="attendance-box ${statusClass}">${status}</div></td>`;
                }).join('');

                // NOTE í‘œì‹œ
                const noteDisplay = member.note || '';
                const noteClass = noteDisplay === 'O' ? 'present' : 
                                noteDisplay === 'X' ? 'absent' : 
                                'empty';

                // ê¹€ë°¥ ì—¬ë¶€ í‘œì‹œ (ì´í˜„ìˆ™9735ëŠ” O(2), ë‚˜ë¨¸ì§€ëŠ” O, ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œ ì—´ì— ëŒë´„ì¸ ê²½ìš° ëŒë´„)
                let lunchDisplay = '';
                if (member.lunch === 'O') {
                    // ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œ ì—´ì— 'ëŒë´„'ì¸ ê²½ìš° 'ëŒë´„' í‘œì‹œ
                    if (isDolbomOnLatestDate(member)) {
                        lunchDisplay = 'ëŒë´„';
                    } else {
                        lunchDisplay = member.id === 'ì´í˜„ìˆ™9735' ? 'O(2)' : 'O';
                    }
                } else if (member.lunch === 'X') {
                    lunchDisplay = 'X';
                }
                const lunchClass = lunchDisplay ? (lunchDisplay.includes('O') ? 'present' : lunchDisplay === 'ëŒë´„' ? 'special' : 'absent') : 'empty';
                const lunchCellClass = lunchDisplay && lunchDisplay.includes('O') ? 'lunch-col present' : lunchDisplay === 'ëŒë´„' ? 'lunch-col absent' : 'lunch-col absent';

                row.innerHTML = `
                    <td>${idx + 1}</td>
                    <td class="check-col ${lunchCellClass}"><div class="attendance-box ${lunchClass}">${lunchDisplay}</div></td>
                    <td class="check-col"><div class="attendance-box ${noteClass}">${noteDisplay}</div></td>
                    <td class="id-col">${member.id}</td>
                    ${attendanceCells}
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            sheet.appendChild(header);
            sheet.appendChild(table);

            return sheet;
        }

        function createLunchSheets() {
            const sheets = [];
            
            // ì…ë ¥ëœ êµì—­ì ê¹€ë°¥ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° (ë¹ˆ ê°’ì€ 0ìœ¼ë¡œ ì²˜ë¦¬)
            const calvinStaffCount = parseInt(document.getElementById('calvinStaffCount').value) || 0;
            const wesleyStaffCount = parseInt(document.getElementById('wesleyStaffCount').value) || 0;
            
            // ìœ„ì¹˜ë³„ë¡œ íŒ€ ê·¸ë£¹í™”: ì¹¼ë¹ˆ / ì›¨ìŠ¬ë¦¬&ìëª¨ì˜ì•„
            const calvinTeams = teamsData.filter(team => team.location === 'ì¹¼ë¹ˆì±„í”Œ');
            const wesleyTeams = teamsData.filter(team => team.location === 'ì›¨ìŠ¬ë¦¬í™€' || team.location === 'ìëª¨ì˜ì•„ì‹¤');

            // ì¹¼ë¹ˆ ì‹œíŠ¸ ìƒì„± (êµì—­ì í¬í•¨)
            if (calvinTeams.length > 0) {
                const staffGroups = calvinStaffCount > 0 ? [{ name: 'ì¹¼ë¹ˆ', count: calvinStaffCount }] : [];
                sheets.push(createLunchSheet('ì¹¼ë¹ˆì±„í”Œ', calvinTeams, 0, staffGroups));
            }

            // ì›¨ìŠ¬ë¦¬&ìëª¨ì˜ì•„ ì‹œíŠ¸ ìƒì„± (êµì—­ì í¬í•¨)
            if (wesleyTeams.length > 0) {
                const staffGroups = wesleyStaffCount > 0 ? [{ name: 'ì›¨ìŠ¬ë¦¬', count: wesleyStaffCount }] : [];
                sheets.push(createLunchSheet('ì›¨ìŠ¬ë¦¬í™€ & ìëª¨ì˜ì•„ì‹¤', wesleyTeams, sheets.length, staffGroups));
            }

            return sheets;
        }

        function createLunchSheet(title, teams, index, staffGroups = []) {
            const sheet = document.createElement('div');
            sheet.className = 'sheet lunch-sheet';
            sheet.id = `lunch-sheet-${index}`;

            // ì „ì²´ ê¹€ë°¥ ê°œìˆ˜ ê³„ì‚° (êµì—­ì í¬í•¨)
            let totalLunchCount = 0;
            staffGroups.forEach(group => {
                totalLunchCount += group.count;
            });
            teams.forEach(team => {
                const lunchCount = calculateTeamLunchCount(team.members);
                totalLunchCount += lunchCount;
            });

            const header = document.createElement('div');
            header.className = 'sheet-header lunch-header';
            
            // êµì—­ì ì •ë³´ HTML ìƒì„±
            let staffInfoHTML = '';
            if (staffGroups.length > 0 && staffGroups.some(g => g.count > 0)) {
                const totalStaffCount = staffGroups.reduce((sum, g) => sum + g.count, 0);
                staffInfoHTML = `<div class="staff-info">êµì—­ì ${totalStaffCount}ê°œ</div>`;
            }
            
            header.innerHTML = `
                <div class="sheet-subtitle">ê¹€ë°¥ ë°°ë¶„ìš© ê³„ìˆ˜í‘œ</div>
                <div class="sheet-title">${title}</div>
                <div class="lunch-summary">
                    <div>ì´ ${totalLunchCount}ê°œ</div>
                    ${staffInfoHTML}
                </div>
            `;

            // ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
            const gridContainer = document.createElement('div');
            gridContainer.className = 'lunch-teams-grid';
            
            // êµì—­ì ë°•ìŠ¤ëŠ” ì œê±°í•˜ê³  ì¼ë°˜ ì¡°ë“¤ë§Œ ê·¸ë¦¬ë“œì— ì¶”ê°€

            teams.forEach(team => {
                // íŒ€ë³„ ê¹€ë°¥ ê°œìˆ˜ ê³„ì‚°
                const lunchCount = calculateTeamLunchCount(team.members);
                
                // ê¹€ë°¥ ë¨¹ëŠ” ì‚¬ëŒê³¼ ë¨¹ì§€ ì•ŠëŠ” ì‚¬ëŒ ë¶„ë¦¬
                // lunch === 'O'ì´ì§€ë§Œ ê°€ì¥ ë§ˆì§€ë§‰ ë‚ ì§œ ì—´ì— 'ëŒë´„'ì¸ ì‚¬ëŒì€ ë³„ë„ë¡œ ë¶„ë¦¬
                const withLunch = team.members.filter(m => m.lunch === 'O' && !isDolbomOnLatestDate(m));
                const withoutLunch = team.members.filter(m => m.lunch !== 'O');
                const dolbomMembers = team.members.filter(m => m.lunch === 'O' && isDolbomOnLatestDate(m));
                
                // íŒ€ ë¸”ë¡ ìƒì„±
                const teamBlock = document.createElement('div');
                teamBlock.className = 'lunch-team-block';
                
                // íŒ€ í—¤ë”
                const teamHeader = document.createElement('div');
                teamHeader.className = 'lunch-team-header';
                
                // íŠ¹ìˆ˜ ìœ„ì¹˜ í‘œì‹œ
                let teamNameDisplay = team.team;
                let locationBadge = '';
                if (team.location === 'ìëª¨ì˜ì•„ì‹¤') {
                    locationBadge = ' <span style="font-size: 11px;">(ìëª¨ì‹¤)</span>';
                } else if (team.location === 'ì—ë“€ì„¼í„°') {
                    locationBadge = ' <span style="font-size: 11px;">(ì—ë“€)</span>';
                }
                
                teamHeader.innerHTML = `
                    <span class="lunch-team-name">${teamNameDisplay}${locationBadge}</span>
                    <span class="lunch-count">${lunchCount}ê°œ</span>
                `;
                teamBlock.appendChild(teamHeader);
                
                // ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ìƒì„± (Oê°€ ìœ„, Xì™€ ëŒë´„ì´ ì•„ë˜)
                const membersList = document.createElement('div');
                membersList.className = 'lunch-members-list';
                
                // ê¹€ë°¥ ë¨¹ëŠ” ì‚¬ëŒ ë¨¼ì € (O)
                withLunch.forEach(member => {
                    const memberRow = document.createElement('div');
                    memberRow.className = 'lunch-member-row';
                    // ì´í˜„ìˆ™9735ëŠ” 2ê°œì´ë¯€ë¡œ "O(2)"ë¡œ í‘œì‹œ, ë‚˜ë¨¸ì§€ëŠ” "O"
                    const statusDisplay = member.id === 'ì´í˜„ìˆ™9735' ? 'O(2)' : 'O';
                    memberRow.innerHTML = `
                        <div class="lunch-member-id">${member.id}</div>
                        <div class="lunch-member-status">${statusDisplay}</div>
                    `;
                    membersList.appendChild(memberRow);
                });
                
                // ëŒë´„ ìƒíƒœì¸ ì‚¬ëŒ (ëŒë´„)
                dolbomMembers.forEach(member => {
                    const memberRow = document.createElement('div');
                    memberRow.className = 'lunch-member-row';
                    memberRow.innerHTML = `
                        <div class="lunch-member-id">${member.id}</div>
                        <div class="lunch-member-status">ëŒë´„</div>
                    `;
                    membersList.appendChild(memberRow);
                });
                
                // ê¹€ë°¥ ë¨¹ì§€ ì•ŠëŠ” ì‚¬ëŒ ë‚˜ì¤‘ì— (X)
                withoutLunch.forEach(member => {
                    const memberRow = document.createElement('div');
                    memberRow.className = 'lunch-member-row';
                    memberRow.innerHTML = `
                        <div class="lunch-member-id">${member.id}</div>
                        <div class="lunch-member-status">X</div>
                    `;
                    membersList.appendChild(memberRow);
                });
                
                teamBlock.appendChild(membersList);
                
                gridContainer.appendChild(teamBlock);
            });

            sheet.appendChild(header);
            sheet.appendChild(gridContainer);

            return sheet;
        }

        function displayControls() {
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('fileInfo').style.display = 'block';
            
            // ì—¬ëŸ¬ íŒŒì¼ì¸ ê²½ìš° íŒŒì¼ëª… í‘œì‹œ
            const files = document.getElementById('csvFile').files;
            if (files.length === 1) {
                document.getElementById('fileName').textContent = files[0].name;
            } else {
                document.getElementById('fileName').textContent = `${files.length}ê°œ íŒŒì¼ (${Array.from(files).map(f => f.name).join(', ')})`;
            }
            
            if (currentMode === 'attendance') {
                document.getElementById('teamCount').textContent = teamsData.length;
                
                const selector = document.getElementById('teamSelector');
                selector.innerHTML = '';
                selector.style.display = 'flex';

                teamsData.forEach((team, index) => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'team-checkbox';
                    checkbox.innerHTML = `
                        <input type="checkbox" id="team-${index}" checked onchange="updateSheetVisibility(${index})">
                        <label for="team-${index}">${team.location} - ${team.team} (${team.members.length}ëª…)</label>
                    `;
                    selector.appendChild(checkbox);
                });
            } else {
                // ê¹€ë°¥ ê³„ìˆ˜ ëª¨ë“œì—ì„œëŠ” ì¡° ì„ íƒê¸° ìˆ¨ê¹€
                document.getElementById('teamCount').textContent = 'ê¹€ë°¥ ê³„ìˆ˜ ëª¨ë“œ';
                document.getElementById('teamSelector').style.display = 'none';
            }
        }

        function updateSheetVisibility(index) {
            if (currentMode === 'lunch') return; // ê¹€ë°¥ ê³„ìˆ˜ ëª¨ë“œì—ì„œëŠ” ì‚¬ìš© ì•ˆ í•¨
            
            const checkbox = document.getElementById(`team-${index}`);
            const sheet = document.getElementById(`sheet-${index}`);
            if (checkbox && sheet) {
                if (checkbox.checked) {
                    sheet.classList.remove('hidden');
                } else {
                    sheet.classList.add('hidden');
                }
            }
        }

        function selectAllTeams() {
            if (currentMode === 'lunch') return; // ê¹€ë°¥ ê³„ìˆ˜ ëª¨ë“œì—ì„œëŠ” ì‚¬ìš© ì•ˆ í•¨
            
            teamsData.forEach((team, index) => {
                const checkbox = document.getElementById(`team-${index}`);
                if (checkbox) {
                    checkbox.checked = true;
                    updateSheetVisibility(index);
                }
            });
        }

        function deselectAllTeams() {
            if (currentMode === 'lunch') return; // ê¹€ë°¥ ê³„ìˆ˜ ëª¨ë“œì—ì„œëŠ” ì‚¬ìš© ì•ˆ í•¨
            
            teamsData.forEach((team, index) => {
                const checkbox = document.getElementById(`team-${index}`);
                if (checkbox) {
                    checkbox.checked = false;
                    updateSheetVisibility(index);
                }
            });
        }

        function printAll() {
            if (currentMode === 'lunch') {
                // ê¹€ë°¥ ê³„ìˆ˜ ëª¨ë“œ: bodyì— lunch-mode í´ë˜ìŠ¤ ì¶”ê°€í•˜ì—¬ ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œ ì¸ì‡„
                document.body.classList.add('lunch-mode');
                
                // ëª¨ë“  ê¹€ë°¥ ì‹œíŠ¸ í‘œì‹œ
                const lunchSheets = document.querySelectorAll('[id^="lunch-sheet-"]');
                lunchSheets.forEach(sheet => {
                    sheet.classList.remove('hidden');
                });
            } else {
                // ì¼ë°˜ ì¶œì„ë¶€ ëª¨ë“œ: lunch-mode í´ë˜ìŠ¤ ì œê±°
                document.body.classList.remove('lunch-mode');
                
                // ëª¨ë“  ì¶œì„ë¶€ ì‹œíŠ¸ í‘œì‹œ
                teamsData.forEach((team, index) => {
                    const sheet = document.getElementById(`sheet-${index}`);
                    if (sheet) {
                        sheet.classList.remove('hidden');
                    }
                });
            }
            
            setTimeout(() => {
                window.print();
                // ì¸ì‡„ í›„ í´ë˜ìŠ¤ ë³µì›
                if (currentMode !== 'lunch') {
                    document.body.classList.remove('lunch-mode');
                }
            }, 100);
        }

        function printSelected() {
            if (currentMode === 'lunch') {
                // ê¹€ë°¥ ê³„ìˆ˜ ëª¨ë“œì—ì„œëŠ” ì „ì²´ ì¸ì‡„ì™€ ë™ì¼
                printAll();
                return;
            }
            
            // ì¼ë°˜ ì¶œì„ë¶€ ëª¨ë“œ: lunch-mode í´ë˜ìŠ¤ ì œê±°
            document.body.classList.remove('lunch-mode');
            
            // ì„ íƒëœ ì‹œíŠ¸ë§Œ í‘œì‹œí•˜ê³  ë‚˜ë¨¸ì§€ ìˆ¨ê¹€
            teamsData.forEach((team, index) => {
                const checkbox = document.getElementById(`team-${index}`);
                const sheet = document.getElementById(`sheet-${index}`);
                if (checkbox && sheet) {
                    if (checkbox.checked) {
                        sheet.classList.remove('hidden');
                    } else {
                        sheet.classList.add('hidden');
                    }
                }
            });

            setTimeout(() => {
                window.print();
                // ì¸ì‡„ í›„ í´ë˜ìŠ¤ ë³µì›
                document.body.classList.remove('lunch-mode');
            }, 100);
        }

        // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (í™”ë©´ ì „ì²´ë¥¼ í•˜ë‚˜ì˜ PDFë¡œ)
        async function downloadAsPDF(button) {
            const { jsPDF } = window.jspdf;
            const container = document.getElementById('attendanceSheets');
            
            if (teamsData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ì¶œì„ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            const originalText = button.textContent;
            button.textContent = 'â³ PDF ìƒì„± ì¤‘...';
            button.disabled = true;

            try {
                // ì „ì²´ ì»¨í…Œì´ë„ˆë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    windowWidth: container.scrollWidth,
                    windowHeight: container.scrollHeight
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                // PDF í¬ê¸° ê³„ì‚° (A4 ì„¸ë¡œ ë°©í–¥)
                const pdfWidth = 210; // A4 ë„ˆë¹„ (mm)
                const pdfHeight = 297; // A4 ë†’ì´ (mm)
                const imgWidth = pdfWidth - 20; // ì¢Œìš° ì—¬ë°± 10mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // ì´ë¯¸ì§€ê°€ í•œ í˜ì´ì§€ë³´ë‹¤ ê¸¸ë©´ ì—¬ëŸ¬ í˜ì´ì§€ë¡œ ë¶„í• 
                const pdf = new jsPDF('p', 'mm', 'a4');
                let heightLeft = imgHeight;
                let position = 0;
                
                // ì²« í˜ì´ì§€
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 20);
                
                // ì¶”ê°€ í˜ì´ì§€
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position + 10, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 20);
                }
                
                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ + ëª¨ë“œ)
                const date = new Date().toISOString().split('T')[0];
                const mode = currentMode === 'lunch' ? 'ê¹€ë°¥ê³„ìˆ˜' : 'ì¶œì„ë¶€';
                pdf.save(`êµë¦¬êµìœ¡_${mode}_ì „ì²´_${date}.pdf`);
                
            } catch (error) {
                console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (í™”ë©´ ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ì´ë¯¸ì§€ë¡œ)
        async function downloadAsImage(button) {
            const container = document.getElementById('attendanceSheets');
            
            if (teamsData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ì¶œì„ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            const originalText = button.textContent;
            button.textContent = 'â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘...';
            button.disabled = true;

            try {
                // ì „ì²´ ì»¨í…Œì´ë„ˆë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    windowWidth: container.scrollWidth,
                    windowHeight: container.scrollHeight
                });
                
                // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                const link = document.createElement('a');
                const date = new Date().toISOString().split('T')[0];
                const mode = currentMode === 'lunch' ? 'ê¹€ë°¥ê³„ìˆ˜' : 'ì¶œì„ë¶€';
                
                link.download = `êµë¦¬êµìœ¡_${mode}_ì „ì²´_${date}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜:', error);
                alert('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì§€ì› (ì—¬ëŸ¬ íŒŒì¼ ê°€ëŠ¥)
        const container = document.querySelector('.container');
        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            container.style.border = '2px dashed #4CAF50';
        });

        container.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            container.style.border = 'none';
        });

        container.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            container.style.border = 'none';

            const files = e.dataTransfer.files;
            
            // CSV íŒŒì¼ë§Œ í•„í„°ë§
            const csvFiles = Array.from(files).filter(f => f.name.endsWith('.csv'));
            
            if (csvFiles.length > 0) {
                // FileListë¥¼ ì§ì ‘ í• ë‹¹í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ DataTransfer ê°ì²´ ì‚¬ìš©
                const dataTransfer = new DataTransfer();
                csvFiles.forEach(file => dataTransfer.items.add(file));
                document.getElementById('csvFile').files = dataTransfer.files;
                
                loadCSV();
            } else {
                alert('CSV íŒŒì¼ì„ ë“œë¡­í•´ì£¼ì„¸ìš”.');
            }
        });
    </script>
</body>
</html>

